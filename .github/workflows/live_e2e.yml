---
name: live-e2e

"on":
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  live-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        case:
          - strict-startup-refuse-unknown-sp-toggle
          - strict-startup-refuse-unsigned-authn-toggle
          - strict-startup-refuse-weak-algorithm-toggle
          - strict-flow-unknown-sp-rejected
          - danger-startup-refuse-unknown-sp-when-toggle-missing
          - danger-startup-refuse-unsigned-authn-when-toggle-missing
          - danger-flow-signed-assertion-success
          - danger-flow-tampered-response-rejected
          - danger-flow-weak-toggle-enabled-still-rejects-tamper
          - danger-flow-signed-authnrequest-required-rejected-without-sp-cert
          - danger-flow-response-signing-required-success

    steps:
      - uses: actions/checkout@v6

      - name: Ensure Docker daemon is running
        run: |
          docker --version
          if ! docker info > /dev/null 2>&1; then
            echo "Docker daemon not reachable, attempting to start service"
            sudo systemctl start docker
          fi
          docker info > /dev/null

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        run: python -m pip install --quiet --no-cache-dir --upgrade uv

      - name: Sync project dependencies
        run: uv sync --all-groups

      - name: Run live e2e case (${{ matrix.case }})
        env:
          CI: "1"
          LIVE_E2E_OUTPUT_MODE: "github-actions"
        run: uv run scripts/live_e2e.py run --case "${{ matrix.case }}"
